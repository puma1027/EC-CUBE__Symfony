$(function(){

	// Gnav show category nav
	$('.js-viewcategory').click(function(){
		var winW = $(window).width();

		$(this).parents('.mainnav__item').toggleClass('open');
		$('.category_menu').toggleClass('c_open');
		$('body').toggleClass('s-open');
		$(this).toggleClass('active');
		$('.searchnav__close').toggleClass('show');
		return false;

	});

	function fnCloseCatMenu() {
		if($('body').hasClass('s-open')) {
			$('body').removeClass('s-open');
			$('.mainnav__item').removeClass('open');
            $('.category_menu').removeClass('c_open');
            $('.js-viewcategory').removeClass('active');
            $('.searchnav__close').removeClass('show');
		}
		if($('.s-overlaymenu').hasClass('s-show')) {
			$('body').removeClass('s-open');
			$('.s-overlaymenu').removeClass('s-show');
            $('.category_menu').removeClass('c_open');
            $('.js-viewcategory').removeClass('active');
            $('.searchnav__close').removeClass('show');
		}
	}
	$('.overlay').click(function() {
		fnCloseCatMenu();
	});
	$('.closebtn').click(function() {
		fnCloseCatMenu();
	});

	// カテゴリリンク要素を複製
	var $categoryListNav = $('.searchnav');
	if($categoryListNav.length) {
		$($categoryListNav).clone(true).addClass('s-overlaymenu').appendTo('body');
		$('.s-overlaymenu').find('.searchbycode').remove();
	}
	$('.js-viewovlcategory').click(function(){
		$('body').toggleClass('s-open');
		$('.s-overlaymenu').addClass('s-show');
		return false;
	});
	// pop up navi(search ui)
	// $('.js-popupnav').find('.categorylist__link').click(function(){
	// 	$(this).toggleClass('s-checked');
	// 	$('.js-searchouter').slideDown();
	// 	return false;
	// });

	// // search nav
	// $('.js-searchnav').click(function() {
	// 	$('.js-popupnav').toggleClass('s-open');
	// 	$('body').addClass('s-open');
	// 	$('body').scrollTop(0);
	// 	$('.mainnav__item').removeClass('open');
	// 	return false;
	// });
	// $('.js-popupnavclose').click(function() {
	// 	if($('.js-popupnav').hasClass('s-open')) {
	// 		$('.js-popupnav').removeClass('s-open');
	// 		$('body').removeClass('s-open');
	// 	}
	// });
	// $('.overlay').click(function() {
	// 	if($('.js-popupnav').hasClass('s-open')) {
	// 		$('.js-popupnav').removeClass('s-open');
	// 		$('body').removeClass('s-open');
	// 	}
	// });

	var $accordionBtn = $('.js-accordionbtn');
	if ($($accordionBtn).length) {
		$($accordionBtn).click(function() {
			$(this).parents('.js-accordion').toggleClass('s-open');
		});
	}

	var $prdctHeadNav = $('.js-producthead');
	if($prdctHeadNav.length) {
		// $prdctHeadNav.offsetTop = $prdctHeadNav.offset().top - $(window).height() + $prdctHeadNav.height();

		$(window).scroll(function() {
			if($(this).scrollTop() >= 300) {
				// console.log($(this).scrollTop(), $prdctHeadNav.offsetTop);
				$($prdctHeadNav).addClass('s-fixed');
				// $('.js-producthead').addClass('s-fixed');
			} else {
				$($prdctHeadNav).removeClass('s-fixed');
				// $('.js-producthead').removeClass('s-fixed');
			}
		});
	}

	var $scrolltoSearchBtn = $('.js-scrolltorefine'); // ボタン
	var $refineMenu = $('#_search'); // 絞り込み検索エリア
	var $productListHeader = $('.productlist__num'); // XX件の商品があります。の見出し要素。高さを酒盗して使用
	if($scrolltoSearchBtn.length) {
		$(window).scroll(function() {
			if($(this).scrollTop() >= ($refineMenu.offset().top - window.outerHeight )) {
				$($scrolltoSearchBtn).removeClass('s-show');
			} else if($(this).scrollTop() >= $productListHeader.offset().top) {
				$($scrolltoSearchBtn).addClass('s-show');

			} else {
				$($scrolltoSearchBtn).removeClass('s-show');
				// $('.js-producthead').removeClass('s-fixed');
			}
		});

		$($scrolltoSearchBtn).click(function() {
			var top_num = $refineMenu.offset();
			if (top_num == null) { alert("このカテゴリは絞り込みがありません"); }
			else {
				$('html, body').animate({
					scrollTop: $refineMenu.offset().top
				}, 300);
				// $($scrolltoSearchBtn).removeClass('s-show');
			}
		})
	}

	$('.js-back').click(function() {
		history.back();
		return false;
	});

	// 商品詳細 レビュー数表示制御
	(function() {

		var $reviewContent = $('.js-uservoicecontent').clone(); // reviewコンテンツをcloneして、配置

		if($reviewContent.length) {
			$($reviewContent).appendTo('.js-uservoicedest');

			var $moreBtn = $('.js-viewmorecommentbtn'); // もっと見るボタン
			$moreBtn.position = $($moreBtn).offset().top  - 50;

			var $userVoiceContent = $('.uservoicedest'); // pop up するコンテンツ

			var $reviewComment = $('.product__review__voice').find('.product__review__voice__item');

			var $overlay = $('.js-overlayforcomment');

			// 4件以上の場合は、3つ表示してボタンを出す
			if($reviewComment.length >= 4) {
				$($reviewComment).hide();
				var i = 1;
				$($reviewComment).each(function() {
					if(i<=3) {
						$(this).show();
						i++;
					}
				});

				$($moreBtn).click(function() {
					$($userVoiceContent).addClass('s-show');
					var position = $(window).scrollTop();
					$('html, body').css('overflow', 'hidden');
					$($overlay).addClass('s-show').css('zIndex', 6);
					$('.uservoicedest__foot').show();
					return false;
				});
			} else {
				// 3件以下の場合、全部出してボタンは非表示
				$('.js-viewmorecommentbtn').hide();
			}

			function closePopUp() {
				$($userVoiceContent).removeClass('s-show');
				$('html, body').css('overflow', 'scroll');
				$($overlay).removeClass('s-show');
				$('.uservoicedest__foot').hide();
			}

			// 閉じるボタンの挙動
			$('.js-popupvoiceclose').click(function() {
				closePopUp();
			});
			$($overlay).click(function() {
				closePopUp();
			});
		}

	})();

	// #_search 付きのURLの場合の処理
	(function(){
		var url = location.href;
		console.log(url);

		function fnScrollPos() {
			if (url.indexOf('#_search') != -1) {
				console.log('exec');
				var scrollPos = $('#_search').offset().top;
				console.log(scrollPos);
				$('html, body').animate({
					scrollTop: scrollPos
				}, 250);
				console.log('終わり');
			}
		}

		// 描画を遅延
		var timer = false;

		if (timer !== false) {
			clearTimeout(timer);
		}
		timer = setTimeout(function() {
			fnScrollPos();
		}, 200);

	})();

	// home ranking accordion
	(function(){
		var $btnSeeMore = $('.js-btnseemore');
		var $btnToList = $('.js-btntolist');
		$($btnToList).hide();
		var $rankingCont = $('.js-rankingcont');

			var windowWidth = $(window).width();
			var windowSm = 640;
			if(windowWidth <= windowSm){
				//横幅640以下の場合
				$($rankingCont).find('li:gt(2)').hide();
			}else{
				$($rankingCont).find('li:gt(3)').hide();
			}

		$($btnSeeMore).click(function(){
			$(this).hide();
			$(this).parents('.widebtnarea').find($btnToList).show();
			$(this).parents('.cmncont__child').find('li').slideDown();
		});
	})();

}); //end of $(function())
